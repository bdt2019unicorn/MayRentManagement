<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    </head>
    <body>
        <input type="file" onchange="GetFile(this)">
        <button onclick="Upload()">Click me </button>
        <script>
            var file; 
            function GetFile(files)
            {
                file = files.files[0]; 
            }
            function Upload()
            {
                let url = "test-upload-chunk.php"; 
                const chunk_size = 2048; 

                var folder = `${file.name}-${Math.ceil(Math.random().toFixed(4) * 10000)}`; 
                var upload_url = "action.php?command=UploadFiles"; 
                var form_data = new FormData(); 
                var part = 1; 
                var UploadFile =(start_slice)=> new Promise
                (
                    (resolve, reject)=>
                    {
                        var next_slice = start_slice + chunk_size + 1; 
                        let data = new FormData(); 
                        let end_of_file = false; 
                        if(next_slice>file.size)
                        {
                            next_slice = file.size; 
                            end_of_file = true; 
                        }
                        data.append("blob", file.slice(start_slice, next_slice)); 
                        data.append("folder", folder); 
                        data.append("part", part); 
                        part++; 

                        $.ajax 
                        (
                            {
                                type: "POST", 
                                url: upload_url, 
                                data, 
                                contentType: false,
                                processData: false,
                                enctype: 'multipart/form-data',
                                success: function()
                                {
                                    if(end_of_file)
                                    {
                                        form_data.set("file", `temp/${folder}`); 
                                        reject(); 
                                    }
                                    resolve(next_slice); 
                                } 
                            }
                        ); 
                    }
                ).then(UploadFile); 

                UploadFile(0).catch 
                (
                    (err)=>
                    {
                        console.log(err); 
                        let string = 
                        `
                            ":name"=> 'test', 
                            ":document_type_id" => '6', 
                            ":unit_id" => '94',
                            ":file_extension" => 'xls', 
                            ":description" => 'test file', 
                            ":username" => 'blastor555', 
                            ":modified_time" => '2021-01-13 17:27:37'
                        `; 

                        var array = string.split(",").map(str=>str.trim()).map(str=>str.split("=>")); 

                        array.forEach
                        (
                            list=>
                            {
                                var key = list[0].replaceAll('"', "").replaceAll(":", "").trim(); 
                                var value = list[1].replaceAll("'", "").trim(); 
                                form_data.append(key, value); 
                            }
                        ); 

                        var result = null; 
                        $.ajax
                        (
                            {
                                type: "post", 
                                url: url, 
                                data: form_data, 
                                async: false, 
                                contentType: false,
                                processData: false,
                                enctype: 'multipart/form-data',
                                success: function(success)
                                {
                                    result = success; 
                                }, 
                                error: function(error)
                                {
                                    console.log(error.responseText); 
                                    console.log(error); 
                                }
                            }
                        ); 

                        console.log(result); 
                    }
                ); 

            }
        </script>
    </body>
</html>